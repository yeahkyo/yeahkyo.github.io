
<!DOCTYPE HTML>
<html lang="en-GB">
<head>
	<meta charset="utf-8">
	<title>谈一谈CoreData  | Yeah,</title>

	<meta name="author" content="Yeah">

<meta name="description" content="最近在写客户端的数据搜集工具YZAnalytics，随后也希望能开源出来让大家可以配合一些后端工具集（如ELK）快速地定制一个自己的数据分析系统。 客户端这一边需要在本地做一些数据的存储，希望用CoreData来做，之前没有深入地使用过CoreData，所以想先近距离好好了解一下CoreData &hellip;"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Yeah," type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	

</head>



<body>
	<header id="header" class="inner"><h1><a href="/">Yeah,</a></h1>
<span class="tagline"></span>
<nav id="main-nav"><ul class="main-nav">
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/archives">Archives</a></li>
</ul>
</nav> 
<nav id="mobile-nav">
 	<div class="alignleft menu"> 
 		<a class="button">Menu</a> 
 		<div class="container"><ul class="main-nav">
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/archives">Archives</a></li>
</ul>
</div> 
 	</div> 
 </nav> 


</header>

	<div id="content" class="inner"><article class="post">
	<header>
		
		<h2 class="title">谈一谈CoreData</h2>
		
		<div class="meta date">



<time class='entry-date' datetime='2016-02-05T16:06:31+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span></time></div>
	</header>

	<div class="entry-content"><p>最近在写客户端的数据搜集工具YZAnalytics，随后也希望能开源出来让大家可以配合一些后端工具集（如ELK）快速地定制一个自己的数据分析系统。</p>

<p>客户端这一边需要在本地做一些数据的存储，希望用CoreData来做，之前没有深入地使用过CoreData，所以想先近距离好好了解一下CoreData。</p>

<p>这一篇主要讲讲CoreData到底能为我们提供什么帮助、大致架构是什么样的；了解怎样配置和进行基本的操作；关于多线程和性能方面的实践方式。</p>

<!--more-->


<h3>CoreData可以解决什么问题</h3>

<p>首先简单看一看CoreData作为一个「产品」能满足我们怎样的需求。</p>

<ol>
<li><p>持久化存储</p>

<p> 持久化存储是开发者最基础需求之一，CoreData在存储层面支持SQLite、XML、Binary多种存储方式。使用CoreData可以免去我们直接操作数据库或者文件的那些繁琐操作。<br/>
实现持久化这一层的功能主要涉及两个类，NSPersistentStore和NSPersistentStoreCoordinator，它们为不同类型的存储格式封装了一套统一的接口。</p></li>
<li><p>ORM(Object Relational Mapping)</p>

<p> 通过继承NSManagedObject类，我们可以借助CoreData完成数据字段到对象属性的映射，然后直接操作对象属性。</p></li>
<li><p>关系数据</p>

<p> CoreData加上SQLite可以帮助我们在客户端使用关系数据库处理比较复杂的需求。</p></li>
<li><p>Lazy loading</p>

<p> CoreData运用一种叫Faulting的技术，对NSManagedObject的属性、甚至是关联的NSManagedObject对象做了lazy loading。为我们有效的减少了不必要的内存使用。</p>

<p> 举个例子，我们从数据库读取了一个Person对象，它有一个属性是company，对应的另一张叫Company的表里的数据，在我们真正使用company属性之前，person的company指向的其实是一个壳对象(fault)，它并没有加载对应的Company表条目里的数据。</p>

<p> 另外提一点的是Uniquing，CoreData为我们保证了对应相同数据的壳对象也会是唯一的，这样就不会出现同一个company的很多个person，在company被真正加载之前指向的却使不同对象。</p></li>
<li><p>Validation</p>

<p> 在ManagedModel的编辑页面我们可以对每个属性加一些constraints，比如最小值、最大值。之后我们可以用 validateValue:forKey:error: 方法来对做validation。
 如果想对一些属性做更复杂的自定义验证，比如age，实现下面这个方法就可以:</p>

<pre><code class="`"> - (BOOL)validateValue:(inout id _Nullable *)ioValue
            forKey:(NSString *)key
             error:(out NSError * _Nullable *)outError;
</code></pre>

<p> 当我们在调用validateValue:forKey:error:时，它不仅会做默认的constraints验证，还会在运行时自动寻找我们的这些自定义验证。</p></li>
<li><p>Change tracking和undo、redo、rollback</p>

<p> NSManagedObjectContext(MOC)维护着与它关联的ManagedObject的修改记录与当前状态，每一个MOC都拥有一个NSUndoManager，它支持着我们对数据操作的undo、redo、reset、rollback这些操作。
 如果你完全不需要这些操作，应该考虑把MOC的undoManager设置为nil，这样可以节省不少内存，也省去CoreData做一些不必要的操作。</p></li>
<li><p>版本管理、数据迁移</p>

<p> 支持数据版本管理，在应用上线后快速迭代过程中，难以避免会改变数据格式。</p></li>
<li><p>多线程</p></li>
<li><p>数据与UI绑定</p>

<p> 我们可以利用NSFetchResultsController轻松地将TableView与CoreData的数据做绑定。数据的变化也可以利用NSFetchResultsÇontroller的回调更新到TableView上。
 由于涉及到更新UI的操作，这里用到的MOC一定得是在MainQueue上运行的。</p></li>
<li><p>支持KVO、KVC</p></li>
<li><p>同步iCloud</p></li>
</ol>


<h3>CoreData怎么用</h3>

<p>快速介绍一下怎么开始使用CoreData吧。</p>

<ol>
<li><p>在Target的Build Phases -> Link Binary With Libraries中，引入CoreData.framework</p></li>
<li><p>添加一个.xcdatamodeld文件，它对应着NSManagedObjectModel，用来描述一组数据的结构。在这里可以使用图形界面增加Entity，也就是对应的NSEntityDescription，用来描述一个一个的数据对象模型，Entity中可以添加NSPropertyDescription，既Attributes、Relationships和FetchedProperties。属性的默认范围等也可以在右侧的面板中设置。</p></li>
<li><p>接下来利用刚刚添加的xcdatamodeld文件创建一个NSManagedObjectModel，然后用这个Object Model构建一个NSPersistentStoreCoordinator，还需要为这个StoreCoordinator配置一个文件用来存储最终数据。想下面伪代码描述了关键的步骤。</p>

<pre><code class="`"> NSManagedObjectModel *managedObjectModel = [[NSManagedObjectModel alloc] initWithContentsOfURL:modelFileURL];
 NSPersistentStoreCoordinator *persistentStoreCoordinator = [[NSPersistentStoreCoordinator alloc] initWithManagedObjectModel:managedObjectModel];
 NSURL *storeURL = [directoryYouWantToStore URLByAppendingPathComponent:@"database.sqlite"];
 [persistentStoreCoordinator addPersistentStoreWithType:NSSQLiteStoreType configuration:nil URL:storeURL options:nil error:&amp;error];
</code></pre></li>
<li><p>有了persistentStoreCoordinator就容易构造NSManagedObjectContext了</p>

<pre><code class="`"> NSManagedObjectContext *managedObjectContext = [[NSManagedObjectContext alloc] initWithConcurrencyType:NSPrivateQueueConcurrencyType];
 [managedObjectContext setPersistentStoreCoordinator:persistentStoreCoordinator];
</code></pre></li>
<li><p>NSFetchRequest、NSPredicate</p>

<p> 数据操作无非就是增删改查，这里我们虽然选择了SQLite作为存储介质，但是并不直接使用SQL来与数据库交互，数据的修改、创建、删除都可以借由NSManagedObject和NSManagedObjectContext来完成。而读取操作需要使用到NSFetchRequest和NSPredicate，他们可以完成对特定数据的读取、排序等操作。对于SQLite存储，最终这些查询会转换成SQL语句交给SQLite来执行，而对于其他的存储介质，这些功能将以纯Cocoa的方式实现，比如说用到字符串大小比较来完成排序等。所以，SQLite在实际生产环境中使用应该是可以得到一个比较快的存取速度的。</p></li>
</ol>


<h3>对数据的操作</h3>

<ol>
<li><p>create</p>

<p> 利用NSEntityDescription的insertNewObjectForEntityName:inManagedObjectContext:方法，在指定的MOC上创建一个新的Managed Object对象，然后就可以操作这个对象的各种属性，最后save对应的MOC就可以将操作保存到文件了。</p></li>
<li><p>fetch</p>

<p> 调用MOC的excuteFetchRequest:error:方法会返回一个NSManagedObject的数组，对应这fetchRequest中描述的读取条件。
 NSFetchRequest的使用也是很方便的，根据entityName就可以构造一个fetchRequest，然后可以通过fetchLimit限制读取数量，绑定predicate来增加限制条件等。</p></li>
<li><p>update</p>

<p> 修改数据其实就是在读取到了指定的数据并映射到managedObject后，直接对对象进行操作，然后save其对应的MOC就行。</p></li>
<li><p>delete</p>

<p> 直接利用MOC的deleteObject:方法即可在context删除指定对象，最后也不要忘记save context。</p></li>
</ol>


<h3>Advanced Topic</h3>

<ol>
<li><p>Concurrcy</p></li>
<li><p>数据一致性</p>

<p> 如果涉及多个MOC操作同一个Managed Object的情况，就要留心数据一致性的问题了，就像我们合并代码一样，需要告诉MOC一个mergePolicy。默认情况的策略是NSErrorMergePolicy，一旦出现conflict会在userInfo的conflictList字段返回一个冲突列表，告诉我们哪些属性已经被修改过了，你可以把这些信息转达给用户，或者手动做一些操作后再保存。
 另外四种策略可以让MOC自动帮我们选择合适的数据保存。 NSMergeByPropertyStoreTrumpMergePolicy:当出现冲突时，保留数据库里已有的数据。
 NSMergeByPropertyObjectTrumpMergePolicy:当出现冲突时，保留当前MOC管理的数据。
 NSOverwriteMergePolicy:无视数据库里的数据版本，直接用当前MOC数据覆盖。
 NSRollbackMergePolicy:如果出现冲突就丢弃当前MOC数据的修改。</p></li>
<li><p>性能优化</p>

<p> If you do not intend to use Core Data’s undo functionality, you can reduce your application&rsquo;s resource requirements by setting the context’s undo manager to nil. This may be especially beneficial for background worker threads, as well as for large import or batch operations.</p>

<p> NSFetchResultsController cache</p></li>
</ol>


<h3>MagicalRecord</h3>

<p><a href="https://github.com/magicalpanda/MagicalRecord">https://github.com/magicalpanda/MagicalRecord</a></p>

<h3>在Analytics中的使用</h3>

<ul>
<li>为什么要用CoreData</li>
<li>内存管理、性能上的注意事项</li>
</ul>


<h3>深入阅读</h3>

<p>想更深入的了解CoreData的一些特性和原理，可以看看《Pro Core Data for iOS》。
豆瓣链接：<a href="http://book.douban.com/subject/10205854/">http://book.douban.com/subject/10205854/</a></p>

<h4>References</h4>

<p>《Core Data Programming Guide》<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreData/ChangeManagement.html#//apple_ref/doc/uid/TP40001075-CH22-SW1">https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreData/ChangeManagement.html#//apple_ref/doc/uid/TP40001075-CH22-SW1</a></p>
</div>


	
	</article>

	
	<div class="share">
	  <!-- <ul> -->
	  <!--   <li>
  <a href="https://twitter.com/intent/tweet?text=谈一谈CoreData by @&url=http://yeahkyo.github.io/blog/2016/02/05/core-data/" title="Share 谈一谈CoreData on Twitter">
    <img src="/images/social/twitter.png" />
  </a>
</li>
 -->
	  <!--   <li>
  <a href="https://www.facebook.com/sharer.php?u=http://yeahkyo.github.io/blog/2016/02/05/core-data/" title="Share 谈一谈CoreData on Facebook">
    <img src="/images/social/facebook.png" />
  </a>
</li>
 -->
	  <!--   <li>
  <a href="https://plus.google.com/share?url=http://yeahkyo.github.io/blog/2016/02/05/core-data/" title="Share 谈一谈CoreData on Google Plus">
    <img src="/images/social/google.png" />
  </a>
</li>
 -->
	  <!-- </ul> -->
	</div>




<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner"><br>
<br>
<br>
<br>
&copy; 2013-2016

    Yeah

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/hyphenator.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'yeahengineer';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://yeahkyo.github.io/blog/2016/02/05/core-data/';
        var disqus_url = 'http://yeahkyo.github.io/blog/2016/02/05/core-data/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-73839746-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>




</body>
<script>
  $(document).ready(function() {
  // Make images center
  $('p:has(img)').css('text-align', 'center');
  });
</script>
</html>
